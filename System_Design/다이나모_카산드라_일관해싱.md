# 카산드라/다이나모 일관된 해싱(Consistent Hashing)
---

### 다이나모 
다이나모는 아마존의 핵심 서비스 중 일부가 ‘항상 켜져있는’(always-on) 경험을 제공하기 위해 사용하는 고가용성 키-값 저장소 시스템이다. 
- S3와 같이 simple storage service 를 제공하며 설계자가 비용 효율성을 고려하는 상황에서 고가용성, 고성능을 달성하기 위한 트레이드오프에 기반해 데이터 저장소를 적절히 설정할 수 있도록 충분히 유연해야 한다.  

데이터는 파티셔닝되며, 안정 해싱[10](consistent hasing)으로 복제된다. 
일관성은 객체 버저닝[12]으로 확보할 수 있다. 
데이터 업데이트 중 레플리카(replicas) 사이의 일관성은 정족수(quorum) 기법과 분산 레플리카 동기화 프로토콜로 유지할 수 있다. 
다이나모는 가십(gossip) 기반의 분산 장애 감지와 멤버십 프로토콜을 사용한다. 
다이나모는 수동으로 관리할 필요 없이 완전히 분산된 시스템이다. 
어떠한 수동 파티셔닝이나 재배포 없이 새 저장소 노드를 추가하거나, 기존 노드를 제거할 수 있다.  


- 다이나모가 사용하는 기술과 그 장점에 대한 요약 

문제	기술	장점
파티셔닝	안정 해싱	점진적 확장 가능성
쓰기 고가용성	읽기 중 조정 가능한 벡터 클럭	버전 크기와 업데이트 양의 분리
일시적인 장애	느슨한 정족수와 임시 위탁	고가용성 제공, 일부 레플리카를 사용할 수 없을 때 내구성을 보장
영구적인 장애 복구	머클 트리를 통한 안티 엔트로피	백그라운드에서 다양한 레플리카를 동기화
멤버십과 장애 감지	가십 기반 멤버십 프로토콜 및 장애 감지	대칭성 유지, 멤버십 및 활성 노드 정보를 저장하는 중앙집중식 레지스트리의 부재

- 시스템 주요 기능 
    1) 파티셔닝된 데이터셋 coordnation 요청
    2) ring 기반 멤버쉽 및 failure 감지
    3) 로컬 퍼시스턴스 저장소 엔진  

1) 파티셔닝 및 복제 
- 주요 설계 요구 사항 중 하나는 점진적으로 확장할 수 있어야 한다는 것 
다이나모의 파티셔닝 방식은 안정 해싱에 의존하여 여러 저장소 호스트들에게 부하를 분산시킬 수 있다. 안정 해싱[10]에서, 해시 함수의 반환 범위는 고정된 원형 공간 또는 “링”(ring, i.e. 가장 큰 해시 값과 가장 작은 해시 값이 연결된 고리 형태)로 취급된다. 시스템의 각 노드는 이 공간 안의 랜덤 값을 배정받으며, 이 값은 링 위에 놓인 “위치”(position)로 표현된다. 키로 식별되는 각 데이터는 자신의 키를 해싱하여 위치를 산출한 다음, 링을 시계 방향으로 돌며 자신의 위치보다 큰 위치에 있는 첫 번째 노드에 자신을 할당한다.  
따라서 각 노드는 링 위의 이전 노드와 자기 자신 사이의 영역을 담당하게 된다. 안정 해싱의 주요 이점은 노드의 추가 또는 제거가 인접한 노드에게만 영향을 미치고, 다른 노드들에게는 영향을 미치지 않는다는 것이다.

- 과제 : 우선 링에 있는 각 노드의 위치를 랜덤하게 배정하면 불균형한 부하 분산을 야기할 수 있다. 또한, 기본적인 알고리즘은 노드의 성능을 신경쓰지 않는다.  
가상 노드는 시스템에서 하나의 노드처럼 보이지만, 각 노드가 하나 이상의 가상 노드를 담당할 수 있으며, 새로운 노드를 시스템에 추가할 때 링에서 여러 위치(이하 “토큰”)가 할당된다

2) 링 기반 멤버쉽 및 장애 감지 
링 멤버십
아마존 환경에서 장애 또는 유지보수 작업으로 인한 노드 중단은 대체로 일시적이지만, 지속 기간이 연장될 수도 있다. 노드 중단이 노드의 영구적인 제거를 의미하는 경우는 거의 없기 때문에 파티션 할당의 재조정이나 도달 불가능한 레플리카의 복구로 이어져서는 안 된다. 비슷하게, 수동 오류는 의도치 않은 새 다이나모 노드를 시작하게 만들 수 있다. 이러한 이유로 다이나모 링에서 노드의 추가 및 제거를 초기화하기 위해 명시적인 메커니즘을 사용하는 것이 적절하다고 여겨졌다. 관리자는 새 노드를 추가하거나 기존 노드를 제거하기 위해 멤버십 변경을 시도하며, 커맨드라인 도구나 브라우저를 이용하여 다이나모 노드에 접속할 수 있다.

쓰기 요청을 처리하는 노드는 멤버십 변경을 수행하며, 변경 시간을 영속적 저장소에 저장해둔다. 노드가 여러차례 제거되거나 다시 추가될 수 있기 때문에 멤버십 변경은 히스토리를 만들게 된다. 가십 기반 프로토콜은 멤버십 변경을 전파하고, 멤버십의 측면에서 최종 일관성을 유지한다. 각 노드는 매 초마다 랜덤한 다른 노드에 접근하며, 두 노드는 지속적으로 멤버십 변경 기록을 동기화한다.

노드가 처음 시작될 때, 토큰 집합(안정 해시 공간의 가상 노드들)을 선택하고 노드를 그에 대응하는 토큰 집합에 매핑한다. 매핑은 디스크에 기록되며, 처음에는 로컬 노드와 토큰 집합만 기록된다. 다른 다이나모 노드에 저장된 매핑은 통신을 통해 중재된다. 따라서 파티셔닝과 위치 정보는 가십 기반 프로토콜을 통해 전파되며, 각 저장소 노드는 다른 노드가 처리하는 토큰 범위를 알게 된다. 이를 통해 각 노드는 키의 읽기, 쓰기 작업을 올바른 노드들에게 직접 전달할 수 있다.

장애 감지
다이나모에서의 장애 감지는 get()이나 put() 명령 실행 중, 또는 파티션 및 임시 위탁된 레플리카를 전송할 때 사용 불가능한 노드와 통신하지 않기 위해 사용한다. 통신 실패를 방지하기 위한 목적으로는, 순수하게 국소적인 장애 감지 개념만으로도 충분하다. 가령 노드 A는 노드 B가 노드 A의 메시지에 응답하지 않으면(노드 B가 노드 C에게 응답했다고 해도) 노드 B에 장애가 발생한 것으로 취급한다. 다이나모 링에서 노드 간 통신을 일으키는 클라이언트 요청이 일정하게 있는 경우, 노드 A는 노드 B가 응답할 수 없는 상태라는 것을 빠르게 발견할 수 있다. 이후 노드 A는 대체 노드를 통해 노드 B의 파티션에 매핑되는 요청을 처리한다. 노드A는 주기적으로 노드 B에게 요청을 보내 복구를 확인한다. 두 노드 간의 트래픽을 일으키는 클라이언트 요청이 없는 경우에는 두 노드 모두 서로가 응답할 수 있는 상태인지 확인할 필요가 없다.

분산된 장애 감지 프로토콜은 단순한 가십 스타일 프로토콜을 사용한다. 가십 프로토콜은 시스템의 각 도느가 다른 노드의 추가 또는 제거를 서로 알 수 있게 해준다. 분산 장애 감지와 정확도에 영향을 미치는 인자에 대한 자세한 내용은 [8]을 참조한다. 다이나모의 초기 설계에서는 전체적으로 일관된 장애 상태를 관리하기 위해 분산 장애 감지를 사용했다. 나중에는 노드의 명시적인 추가 및 제거 방식이 장애 상태에 대한 전역적인 감지의 필요성을 없앤다는 것이 밝혀졌다. 노드의 명시적인 추가 및 삭제 방식으로 노드들이 알림을 받고, 요청을 전달하는 동안 다른 노드와 통신하지 못할 때 개별 노드가 일시적인 노드 장애를 감지하기 때문이다. 


3) 로컬 퍼시스테ㅓㄴ트 

다이나모의 각 저장소 노드에는 세 가지 중요한 소프트웨어 컴포넌트가 있다: 요청 처리, 멤버십, 장애 감지, 로컬 영속성 엔진이 그것이다. 이 모든 컴포넌트가 자바로 구현되어 있다.

다이나모의 로컬 영속성 컴포넌트는 다른 저장소 엔진을 플러그인으로 적용할 수 있게 해준다. 이때 엔진은 Berkeley Database(BDB) Transactional Data Store[2], BDB Java Edition, MySQL, 영속적 저장소와 함께 사용하는 인메모리 버퍼다. 플러그인 사용 가능한(pluggable) 영속적 컴포넌트를 설계한 주요 이유는 애플리케이션의 접근 패턴에 따라 최적의 저장소 엔진을 고를 수 있게 하기 위함이다. 예를 들어, BDB는 수십 킬로바이트 단위로 객체를 처리할 수 있는 반면 MySQL은 더 큰 크기의 객체를 처리할 수 있다. 애플리케이션은 객체 크기 분포에 따라 다이나모의 로컬 영속성 엔진을 선택한다. 프로덕션 환경의 다이나모 인스턴스는 주로 BDB Transactional Data Store를 사용한다.



### 카산드라?  
위 기능들을 기반으로 카산드라를 생성하였다. 
아파치 카산드라는 아마존 다이나모 분산 키값 저장소의 기술을 기반으로 만들어져 있다. 

카산드라는 처음 2개의 클러스터링 구조를 기반으로 설계되었습니다. 그리고 LSM(Log Structured Merge Tree)를 기반으로 저장소 엔진을 사용합니다.

 

- 일관된 해싱을 통한 데이터셋 파티셔닝 수행

- 버저닝된 데이터와 조정 가능한 consistency를 통한 멀티 마스터 데이터 복제

- 가십 프로토콜(gossip protocol)을 사용한 분산 클러스터 멤버쉽 추가 및 장애 감지

- 범용 하드웨어를 사용한 스케일 아웃

 

카산드라는 페타바이트 이상의 대규모 비즈니스에서도 저장소 요구사항을 충족하기 위해 이런 특징을 가지게 되었습니다. 특히, 애플리케이션이 항상 사용가능하며 짧은 지연의 읽기/쓰기 시간 그리고 페타바이트급 데이터셋의 전체 글로벌 복제를 지원합니다. 카산드라가 없었을 때 관계형 데이터베이스 시스템들의 스케일 아웃 이슈와 여러 요구사항에 대응할 수 없었기 때문에 이러한 기능을 지원하게 되었습니다.