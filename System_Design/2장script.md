저번주에 간단히 말씀 드렸다 싶이 이번주는 무상태 웹 계층에 대한 조사를 해보았는데 무상태 웹 계층에 대한 이해, 로드 밸런싱 전략들과 문제점 해결 방안, NoSQL 을 활용한 무상태 아키텍쳐 그리고 오토 스케일링에 대한 개념을 설명 드리겠습니다. 

무상태 웹 계층은 웹 계층을 수평 확장을 할때는 세션 정보와 같은 상태 정보를 서버에서 제거하고 RDBMS/NoSQL 와 같은 저장소에 저장하고 필요시 가져오는 방식을 아키텍쳐를  말합니다. 

먼저 상태 정보에 의존적인 아키텍쳐 부터 설명해 보겠습니다. 

쿠키와 세션같은 클라이언트 상태 정보를 서버 요청들 사이에 공유 가능하도록 하게 하며 같은 클라이언트가 같은 서버를 사용하도록 하려면 로드밸런서 sticky session 기능을 이용할 수 잇지만 로드 밸런서에게 부담을 준고 서버를 추가하거나 제거하기도 까다로워지기 때문에 서버의 장애를 처리하기도 복잡해 진다고 합니다. 

로드 밸런서의 종류로는 
L4 로드밸런서와 L7 로드밸런서가 있습니다. 

L4 로드밸런서 : 네트워크(IP) 계층이나 트랜스포트(TCP, UDP) 계층 정보를 바탕으로 분산하여 connection load balancer (CLB)/ session load balancer (SLB) 라곱 불립니다. 전략으로는 round robin, least connection, response time, hash, bandwidth(대역폭 고려하여 트랜잭션 분산) 하는 방법이 있습니다. 
L7 로드밸런서 는 L4 로드밸런서 기능 + OSI 7계층 프로토콜 바탕으로 분산 처리 를 하고 전략으로는 URL switching/ context switching/ persisitence with cookie가 있습니다. 
상위 계층으로 갈수록 섬세한 부하 분산이 가능하지만 가격이 비싸지고 하위 계층으로 갈수록 간단한 부하 분산이 가능하고 가격이 저렴해진다.  

그러면 로드밸런서의 스티키 세션이란 무엇인가하면 유저가 로그인 요청을 하였을때 세션 정보는 해당 서버에 저장되게 된다. 하지만 수평확장을 했을 경우 다음 request 는 다른 서버에 전달 될 수도 있다. 그러면 세션에 대한 정보가 없어 `세션 불일치(정합성) 문제`가 발생하는데 이것을 해결하기 위한 방법 중 하나가 sticky session 입니다. 

해결방법으로는 첫번째 스티키 세션은 항상 해당 클라이언트의 세션이 저장된 서버로 해당 서버에 고정 (쿠키 판단/ IP 확인 방법) 하여 전달합니다. 그리고 세션 정보가 없는 경우 기본 알고리즘 대로  요청 전달합니다.  
- [문제점]
특정 서버에 트래픽이 집중될 수 있고 서버에 장애가 생기면 세션 정보가 모두 유실된다. (가용성)  

두번째로는 session clustering 입니다.  

 특정 서버에 세션이 생성될때 다른 서버로 세션을 복제하여 세션 불일치 해결합니다. 이러면 한 서버에 부하가 몰리는 현상 해결 가능 
- [문제점]
 하지만 비효율적 메모리 관리
- 데이터 복제 과정에서 sticky session 방식에 비해 많은 네트워크 트레픽 사용
그리고 복제 과정 중 시간차로 인해 세션 불일치 이슈 발생 가능 합니다.  

세번째로는 session storage 분리가 있습니다. 
외부 서버로 분리 (In-Memory DB ex.Redis) 사용 
    - Disk based DB 사용하면 잦은 세션 입출력 특성상 I/O성능이 느린 DB 적절하지 않고 영속성을 보장할 필요가 없다. 
    - Key-Value 로 세션을 저장하여 Redis 와 Memcached 사용 적절하다. 
- 가용성 해결 가능/ 메모리 효율성 및 트래픽 증가/시간차 세션 불일치 해결 가능 
- [단점]
    - 하나뿐인 스토리지에 장애가 발생하면 모든 세버가 세션 데이터를 정상적으로 사용할 수 없다. 
       - 해결 방법 : 세션 스토리지를 여러개 구성 
